################### :: Test infrastructure for fastapi-tenancy :: #####################
# Starts all external services needed by every vendor test + Redis.                  #
#                                                                                     #
# Usage:                                                                              #
#   docker compose -f docker-compose.test.yml up -d                                  #
#   pytest --tb=short -q                                                              #
#   docker compose -f docker-compose.test.yml down -v                                #
#                                                                                     #
# Env vars (see tests/conftest.py — all have sane localhost defaults):               #
#   POSTGRES_URL  postgresql+asyncpg://postgres:postgres@localhost:5432/test_tenancy  #
#   MYSQL_URL     mysql+aiomysql://root:root@localhost:3306/test_tenancy              #
#   MSSQL_URL     mssql+aioodbc://sa:YourStr0ng!Pass@localhost:1433/master            #
#                 ?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes   #
#   REDIS_URL     redis://localhost:6379/0                                            #
#######################################################################################

services:

  # ── PostgreSQL 16 ──────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: ft_test_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: test_tenancy
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 5s
      retries: 10
    volumes:
      - ft_pg_data:/var/lib/postgresql/data
    tmpfs:
      - /tmp

  # ── MySQL 8.0 ──────────────────────────────────────────────────────────────────
  mysql:
    image: mysql:8.0
    container_name: ft_test_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: test_tenancy
      MYSQL_ROOT_HOST: "%"
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 5s
      timeout: 10s
      retries: 15
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - ft_mysql_data:/var/lib/mysql

  # ── SQL Server 2022 (Developer — free for dev/test) ───────────────────────────
  # Requires: amd64 host OR Rosetta 2 on Apple Silicon, ≥ 2 GB Docker RAM.
  # The SA password must satisfy SQL Server complexity rules (upper + digit + symbol).
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ft_test_mssql
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStr0ng!Pass"
      MSSQL_PID: Developer
    ports:
      - "1433:1433"
    healthcheck:
      # sqlcmd ships inside the image; -No disables certificate validation
      test:
        - "CMD-SHELL"
        - >-
          /opt/mssql-tools18/bin/sqlcmd
          -S localhost -U sa -P 'YourStr0ng!Pass'
          -No -Q 'SELECT 1' > /dev/null 2>&1
      interval: 10s
      timeout: 15s
      retries: 20
      start_period: 30s
    volumes:
      - ft_mssql_data:/var/opt/mssql
    deploy:
      resources:
        limits:
          memory: 2G

  # ── Redis 7 ────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: ft_test_redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 10
    command: redis-server --save "" --appendonly no   # pure in-memory, fast

volumes:
  ft_pg_data:
  ft_mysql_data:
  ft_mssql_data:
